/*
    This is a minimal C program executed on the FPGA version of Patmos.
    An embedded Hello World program: a blinking LED.

    Additional to the blinking LED we write to the UART '0' and '1' (if
   available).

    Author: Martin Schoeberl
    Copyright: DTU, BSD License
*/

#include <math.h>
#include <stdbool.h>
#include <stdint.h>

#include "include/bootable.h"
#include <machine/spm.h>

#define LOOP_DELAY 2000
#define LINE_WIDTH 640
#define DISPLAY_HEIGTH 480

#define RAD 200     // radius in pixel
#define RADCOLOUR 3 // color of radius

volatile uint8_t (*vga_arr)[DISPLAY_HEIGTH][LINE_WIDTH] = 400000;

int main() {

  int disp[480][2] = {
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {306, 335}, {301, 340}, {296, 345},
      {293, 348}, {289, 352}, {286, 355}, {284, 357}, {281, 360}, {279, 362},
      {277, 364}, {275, 366}, {273, 368}, {271, 370}, {269, 372}, {268, 373},
      {266, 375}, {265, 376}, {263, 378}, {262, 379}, {261, 380}, {259, 382},
      {258, 383}, {257, 384}, {256, 385}, {254, 387}, {253, 388}, {252, 389},
      {251, 390}, {250, 391}, {249, 392}, {248, 393}, {247, 394}, {246, 395},
      {245, 396}, {245, 396}, {244, 397}, {243, 398}, {242, 399}, {241, 400},
      {241, 400}, {240, 401}, {239, 402}, {238, 403}, {238, 403}, {237, 404},
      {236, 405}, {236, 405}, {235, 406}, {234, 407}, {234, 407}, {233, 408},
      {233, 408}, {232, 409}, {232, 409}, {231, 410}, {231, 410}, {230, 411},
      {230, 411}, {229, 412}, {229, 412}, {228, 413}, {228, 413}, {228, 413},
      {227, 414}, {227, 414}, {226, 415}, {226, 415}, {226, 415}, {225, 416},
      {225, 416}, {225, 416}, {225, 416}, {224, 417}, {224, 417}, {224, 417},
      {223, 418}, {223, 418}, {223, 418}, {223, 418}, {223, 418}, {222, 419},
      {222, 419}, {222, 419}, {222, 419}, {222, 419}, {221, 420}, {221, 420},
      {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420},
      {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420},
      {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420},
      {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420}, {221, 420},
      {221, 420}, {221, 420}, {221, 420}, {222, 419}, {222, 419}, {222, 419},
      {222, 419}, {222, 419}, {223, 418}, {223, 418}, {223, 418}, {223, 418},
      {223, 418}, {224, 417}, {224, 417}, {224, 417}, {225, 416}, {225, 416},
      {225, 416}, {225, 416}, {226, 415}, {226, 415}, {226, 415}, {227, 414},
      {227, 414}, {228, 413}, {228, 413}, {228, 413}, {229, 412}, {229, 412},
      {230, 411}, {230, 411}, {231, 410}, {231, 410}, {232, 409}, {232, 409},
      {233, 408}, {233, 408}, {234, 407}, {234, 407}, {235, 406}, {236, 405},
      {236, 405}, {237, 404}, {238, 403}, {238, 403}, {239, 402}, {240, 401},
      {241, 400}, {241, 400}, {242, 399}, {243, 398}, {244, 397}, {245, 396},
      {245, 396}, {246, 395}, {247, 394}, {248, 393}, {249, 392}, {250, 391},
      {251, 390}, {252, 389}, {253, 388}, {254, 387}, {256, 385}, {257, 384},
      {258, 383}, {259, 382}, {261, 380}, {262, 379}, {263, 378}, {265, 376},
      {266, 375}, {268, 373}, {269, 372}, {271, 370}, {273, 368}, {275, 366},
      {277, 364}, {279, 362}, {281, 360}, {284, 357}, {286, 355}, {289, 352},
      {293, 348}, {296, 345}, {301, 340}, {306, 335}, {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},
      {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0},     {0, 0}};

  uint8_t color = 15;
  volatile _SPM int *led_ptr = (volatile _SPM int *)PATMOS_IO_LED;

    // for (int r = (DISPLAY_HEIGTH / 2 - RAD); r < DISPLAY_HEIGTH / 2 + RAD;
    // r++) {
    //   for (int c = LINE_WIDTH / 2 - RAD; c < LINE_WIDTH / 2 + RAD; c++) {
    //     if ((pow((c - LINE_WIDTH / 2), 2) + pow((r - DISPLAY_HEIGTH / 2), 2))
    //     <
    //         pow(RAD, 2)) {
    //       (*vga_arr)[r][c] = RADCOLOUR;
    //     } else {
    //       (*vga_arr)[r][c] = 63;
    //     }
    //   }
    // }

  //for (int i = 0; i < 600; i++) {
    for (int r = 0; r < DISPLAY_HEIGTH; r++) {
      for (int c = 0; c < LINE_WIDTH; c++) {
        // if ((r >> 1) % 7 == 0) {
        if ((c >> 1) % 7 == 0) {
          (*vga_arr)[r][c] = color;
        } else {
          (*vga_arr)[r][c] = color >> 2;
        }
      }

      //  else {
      //     if ((c >> 1) % 7 == 0) {
      //       (*vga_arr)[r][c] = color >> 2;
      //     } else {
      //       (*vga_arr)[r][c] = color;
      //     }
      // }
      // }
    }
 // }

  for (int r = 0; r < DISPLAY_HEIGTH; r++) {
    (*vga_arr)[r][63] = 0;
    (*vga_arr)[r][63 + 1] = 0;
    (*vga_arr)[r][63 + 2] = 0;
    (*vga_arr)[r][63 + 3] = 0;
  }

  //     int e, f;
  //           for (e = LOOP_DELAY; e != 0; --e)
  //           for (f = LOOP_DELAY; f != 0; --f)
  //             *led_ptr = 1;
  //   }

    for (int r = 0; r < DISPLAY_HEIGTH; r++) {
      //for (int c = 0; c < LINE_WIDTH; c++) {
  		  (*vga_arr)[r][disp[r][0]] = 0;
  		  (*vga_arr)[r][disp[r][1]] = 0;

      //}
  }

  //     for (int r = 0; r < DISPLAY_HEIGTH ; r++) {
  //       for (int c = 0; c < LINE_WIDTH; c++) {
  //       if (r%2==0)  {
  // 		(*vga_arr)[r][c] = RADCOLOUR;
  //       }
  // 	  else{
  // 		  (*vga_arr)[r][c] = 0;

  // 	  }
  //     }
  //   }

  int i, j;

  for (;;) {

    for (int r = 0; r < DISPLAY_HEIGTH; r++) {
      for (int c = 0; c < LINE_WIDTH; c++) {
        UART_DATA = 'A';
        for (i = LOOP_DELAY; i != 0; --i)
          for (j = LOOP_DELAY; j != 0; --j)
            *led_ptr = 1;

        UART_DATA = (*vga_arr)[r][c];
        for (i = LOOP_DELAY; i != 0; --i)
          for (j = LOOP_DELAY; j != 0; --j)
            *led_ptr = 0;
      }
    }
  }
}